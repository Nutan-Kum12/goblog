services:

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    container_name: goblog_auth
    env_file:
      - .env
    environment:
      # Server Configuration
      - HOST=0.0.0.0
      - AUTH_SERVICE_PORT=${AUTH_SERVICE_PORT:-50051}
      
      # Database Configuration (Use MongoDB Atlas)
      - MONGO_URI=${MONGO_URI}
      - DATABASE_NAME=${DATABASE_NAME:-goblog}
      
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      
      # Email/SMTP Configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME}
      
      # OTP Configuration
      - OTP_LENGTH=${OTP_LENGTH:-6}
      - OTP_EXPIRY_MINUTES=${OTP_EXPIRY_MINUTES:-15}
      
      # Token Configuration
      - ACCESS_TOKEN_EXPIRY_HOURS=${ACCESS_TOKEN_EXPIRY_HOURS:-1}
      - REFRESH_TOKEN_EXPIRY_DAYS=${REFRESH_TOKEN_EXPIRY_DAYS:-7}
      
      # Development Configuration
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEV_MODE=${DEV_MODE:-true}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      
      # Security Configuration
      - BCRYPT_COST=${BCRYPT_COST:-12}
      - MAX_LOGIN_ATTEMPTS=${MAX_LOGIN_ATTEMPTS:-5}
      - ACCOUNT_LOCKOUT_DURATION_MINUTES=${ACCOUNT_LOCKOUT_DURATION_MINUTES:-30}
      
      # Rate Limiting
      - RATE_LIMIT_RPS=${RATE_LIMIT_RPS:-10}
      
      # Inter-service Communication (Docker network)
      - USER_SERVICE_URL=user-service:50052
    ports:
      - "${AUTH_SERVICE_PORT:-50051}:${AUTH_SERVICE_PORT:-50051}"
    networks:
      - goblog_network
    restart: unless-stopped

  # User Service
  user-service:
    build:
      context: .
      dockerfile: services/user/Dockerfile
    container_name: goblog_user
    env_file:
      - .env
    environment:
      # Server Configuration
      - HOST=0.0.0.0
      - USER_SERVICE_PORT=${USER_SERVICE_PORT:-50052}
      
      # Database Configuration (Use MongoDB Atlas)
      - MONGO_URI=${MONGO_URI}
      - DATABASE_NAME=${DATABASE_NAME:-goblog}
      
      # Development Configuration
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      
      # Rate Limiting
      - RATE_LIMIT_RPS=${RATE_LIMIT_RPS:-10}
      
      # Inter-service Communication (Docker network)
      - AUTH_SERVICE_URL=auth-service:50051
    ports:
      - "${USER_SERVICE_PORT:-50052}:${USER_SERVICE_PORT:-50052}"
    depends_on:
      - auth-service
    networks:
      - goblog_network
    restart: unless-stopped

  # Post Service
  post-service:
    build:
      context: .
      dockerfile: services/post/Dockerfile
    container_name: goblog_post
    env_file:
      - .env
    environment:
      # Server Configuration
      - HOST=0.0.0.0
      - POST_SERVICE_PORT=${POST_SERVICE_PORT:-50053}
      
      # Database Configuration (Use MongoDB Atlas)
      - MONGO_URI=${MONGO_URI}
      - DATABASE_NAME=${DATABASE_NAME:-goblog}
      
      # Development Configuration
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      
      # Rate Limiting
      - RATE_LIMIT_RPS=${RATE_LIMIT_RPS:-10}
      
      # Inter-service Communication (Docker network)
      - AUTH_SERVICE_URL=auth-service:50051
      - USER_SERVICE_URL=user-service:50052
      
      # Post Service Specific
      - MAX_POSTS_PER_PAGE=${MAX_POSTS_PER_PAGE:-100}
      - MAX_IMAGE_SIZE=${MAX_IMAGE_SIZE:-5242880}  # 5MB in bytes
    ports:
      - "${POST_SERVICE_PORT:-50053}:${POST_SERVICE_PORT:-50053}"
    depends_on:
      - auth-service
      - user-service
    networks:
      - goblog_network
    restart: unless-stopped

  # Gateway Service
  gateway-service:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: goblog_gateway
    env_file:
      - .env
    environment:
      # Server Configuration
      - HOST=0.0.0.0
      - GATEWAY_PORT=${GATEWAY_PORT:-8080}
      
      # Development Configuration
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      
      # CORS Configuration
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - CORS_ALLOWED_METHODS=${CORS_ALLOWED_METHODS}
      - CORS_ALLOWED_HEADERS=${CORS_ALLOWED_HEADERS}
      
      # Rate Limiting
      - RATE_LIMIT_RPS=${RATE_LIMIT_RPS:-10}
      
      # Inter-service Communication (Docker network)
      - AUTH_SERVICE_URL=auth-service:50051
      - USER_SERVICE_URL=user-service:50052
      - POST_SERVICE_URL=post-service:50053
    ports:
      - "${GATEWAY_PORT:-8080}:${GATEWAY_PORT:-8080}"
    depends_on:
      - auth-service
      - user-service
      - post-service
    networks:
      - goblog_network
    restart: unless-stopped

networks:
  goblog_network:
    driver: bridge
